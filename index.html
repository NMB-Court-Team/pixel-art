<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>像素画编辑器</title><style>*{box-sizing:border-box;margin:0;padding:0}body{background:linear-gradient(135deg,#667eea 0,#764ba2 100%);font-family:Segoe UI,Arial,sans-serif;min-height:100vh;padding:20px}.container{max-width:1400px;margin:0 auto;background:rgba(255,255,255,.95);border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);padding:30px}h1{text-align:center;color:#667eea;margin-bottom:30px;font-size:2.2em}.main-content{display:flex;gap:30px;flex-wrap:wrap}.canvas-area{flex:1;min-width:500px;display:flex;flex-direction:column;align-items:center;position:relative}.remap-cell{width:30px;height:30px;border-radius:4px;cursor:pointer;border:1px solid rgba(0,0,0,.2)}.remap-cell.selected{outline:2px solid #ff9800}#canvasWrapper{position:relative}#canvas{border:3px solid #667eea;background:#fff;box-shadow:0 4px 15px rgba(0,0,0,.2);border-radius:5px;display:inline-grid;cursor:crosshair;user-select:none}#previewLayer{position:absolute;top:3px;left:3px;pointer-events:none;z-index:40}#selectionLayer{position:absolute;top:3px;left:3px;pointer-events:none;z-index:50}.pixel{border:1px solid rgba(0,0,0,.05);transition:opacity .08s}.control-panel{width:360px;display:flex;flex-direction:column;gap:4px}.panel-section{background:#f8f9fa;padding:10px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.1)}.panel-section h3{color:#667eea;margin-bottom:10px;font-size:1em}.btn-group{display:flex;flex-wrap:wrap;gap:10px}button{padding:7px 14px;border:none;border-radius:8px;background:#667eea;color:#fff;cursor:pointer;font-weight:600;position:relative}button.active{background:#764ba2;box-shadow:inset 0 2px 5px rgba(0,0,0,.15)}.color-palette{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}.color-btn{width:35px;height:35px;border-radius:8px;border:3px solid transparent;cursor:pointer}.color-btn.selected{border-color:#667eea;box-shadow:0 0 0 2px #fff,0 0 0 4px #667eea}textarea{width:100%;min-height:150px;padding:10px;border:2px solid #ddd;border-radius:8px;font-family:monospace}.size-controls{display:flex;gap:10px;align-items:center;margin-top:10px}input[type=number]{width:80px;padding:8px;border-radius:8px;border:2px solid #ddd}.small-note{font-size:12px;color:#666;margin-top:8px}.sel-pixel{position:absolute;pointer-events:none;background-image:repeating-linear-gradient(135deg,rgba(255,165,0,.25) 0 6px,transparent 6px 12px);mix-blend-mode:normal;z-index:50}.sel-border{position:absolute;pointer-events:none;border:1px dashed rgba(255,140,0,.95);box-sizing:border-box;z-index:55}.sel-preview{position:absolute;pointer-events:none;background-image:repeating-linear-gradient(135deg,rgba(255,165,0,.18) 0 6px,transparent 6px 12px);z-index:49;box-sizing:border-box}button[title]:hover::after{content:attr(title);position:absolute;left:50%;transform:translate(-50%,-140%);background:rgba(0,0,0,.78);color:#fff;padding:6px 8px;border-radius:6px;white-space:nowrap;font-size:12px;z-index:80}.no-grid .pixel{border:none!important}.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background-color:rgba(0,0,0,.8);color:#fff;text-align:center;border-radius:5px;padding:10px;z-index:1000;opacity:0;transition:opacity .3s ease-in-out}.toast.show{opacity:1}#toyAvatar{position:fixed;right:18px;bottom:18px;width:72px;height:72px;border-radius:18px;background:linear-gradient(180deg,#ffecec,#ffd9d9);box-shadow:0 8px 22px rgba(0,0,0,.25);display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:9999;transform-origin:center;transition:transform 120ms ease,box-shadow 120ms ease;user-select:none}#toyAvatar .face{width:64%;height:64%;display:block}@keyframes squeeze{0%{transform:scale(1,1)}20%{transform:scale(1.14,.78)}55%{transform:scale(.95,1.05)}100%{transform:scale(1,1)}}#toyAvatar.squeeze{animation:squeeze 360ms cubic-bezier(.2,.9,.3,1)}#toyAvatar:active{box-shadow:0 4px 10px rgba(0,0,0,.28)}#toyAvatar .hint{position:absolute;right:25%;bottom:100%;margin-bottom:6px;background:rgba(0,0,0,.75);color:#fff;padding:6px 8px;border-radius:6px;font-size:12px;white-space:nowrap;opacity:0;transform:translateY(6px);transition:opacity .12s,transform .12s;pointer-events:none}#toyAvatar:hover .hint{opacity:1;transform:translateY(0)}</style></head><body><div class="container"><h1>🎨 像素画编辑器</h1><div class="main-content"><div class="canvas-area"><div id="canvasWrapper"><div id="canvas"></div><div id="previewLayer"></div><div id="selectionLayer"></div></div><div id="helpSection" style="margin-top:20px;padding:12px 16px;border-radius:8px;background:#f9fafc;border:1px solid #d0d4e4;max-width:800px;line-height:1.6"><h2 style="margin-top:0">🧭 使用说明</h2><ul style="margin:0;padding-left:20px"><li><b>🧩 网格</b> 按钮：显示 / 隐藏画布网格</li><li><b>Alt</b>：临时进入取色模式, 松开后恢复上一个工具</li><li><b>选区</b>高亮为橙色半透明斜线, 粘贴后可拖动, 按 Enter 放置, Esc 取消</li><li><b>Shift + 拖动</b>：在矩形选区模式下叠加选区</li><li><b>Ctrl + C / X / V</b>：复制 / 剪切 / 粘贴选区</li><li><b>Enter</b>：确认移动或粘贴的预览</li><li><b>Esc</b>：取消粘贴或清除选区</li><li><b>🎨 颜色重映射</b> 点击两个颜色进行互换, 将颜色重新映射</li><li><b>🎲</b> 按钮：随机打乱颜色, 重新映射</li><li><b>↩️</b> 按钮：恢复原始颜色映射</li><li><b>保存与导出</b>：点击右上角的导出按钮保存为文件</li></ul><p style="margin-top:10px;color:#555">💡 提示：选区支持矩形和手涂两种方式；手涂选取为逐像素切换选中状态。</p></div></div><div class="control-panel"><div class="panel-section"><h3>工具</h3><div class="btn-group"><button id="pen" class="active" title="画笔 (左键绘制)">🖌️ 画笔</button> <button id="eraser" title="橡皮擦">🧹 橡皮擦</button> <button id="eyedropper" title="取色">🎯 取色</button> <button id="line" title="直线">📏 直线</button> <button id="rect" title="矩形">⬛ 矩形</button> <button id="circle" title="圆形">⚪ 圆形</button> <button id="fill" title="填充">💧 填充</button> <button id="undo" title="撤回 (Ctrl+Z)">↩️ 撤回</button> <button id="redo" title="重做 (Ctrl+Y)">↪️ 重做</button> <button id="clear" style="background:#e74c3c" title="清空">🗑️ 清空</button> <button id="toggleGrid" title="显示/隐藏网格">🧩 网格</button></div><div style="margin-top:12px"><strong>选区</strong><div class="btn-group" style="margin-top:8px"><button id="selRect" title="矩形选取 (Shift 叠加)">▭ 矩形选取</button> <button id="selFree" title="手涂逐像素选取（再次涂则取消）">✍️ 手涂选取</button> <button id="selMove" title="移动选区 (剪切并粘贴)">⤴️ 移动</button> <button id="selCopy" title="复制选区 (Ctrl+C)">📄 复制</button> <button id="selCut" title="剪切选区 (Ctrl+X)">✂️ 剪切</button> <button id="selPaste" title="粘贴 (Ctrl+V)">📌 粘贴</button> <button id="selClear" title="清除选区 (Esc)">✖️ 清除选区</button></div></div></div><div class="panel-section"><h3>对称模式</h3><div class="btn-group"><button class="symmetry-btn" data-mode="none" title="无对称">无对称</button> <button class="symmetry-btn" data-mode="horizontal" title="水平镜像">水平镜像</button> <button class="symmetry-btn" data-mode="vertical" title="竖直镜像">竖直镜像</button> <button class="symmetry-btn" data-mode="both" title="双向镜像">双向镜像</button> <button class="symmetry-btn" data-mode="rotate4" title="4向旋转">4向旋转</button> <button class="symmetry-btn" data-mode="rotate8" title="8向旋转">8向旋转</button></div></div><div class="panel-section"><h3>调色板</h3><div class="color-palette" id="colorPalette"></div><div style="display:flex;gap:10px;margin-top:10px"></div><div id="paletteRemap" style="margin-top:12px;padding:10px;border:1px solid #ccc;border-radius:8px"><div style="display:flex;align-items:center;gap:10px;margin-bottom:8px"><strong>🎨 颜色重映射：</strong> <button id="shuffleColors" title="随机打乱调色板顺序">🎲</button> <button id="resetRemap" title="恢复原始顺序">↩️</button></div><div id="remapGrid" style="display:grid;grid-template-columns:repeat(auto-fill,30px);gap:8px"></div><small style="color:#666">点击两个颜色交换它们的映射, 或使用 🎲 随机打乱。</small></div></div><div class="panel-section"><h3>导出/导入</h3><div class="btn-group" style="margin-bottom:10px"><button id="exportBtn" style="flex:1">📋 导出/复制到剪贴板</button> <button id="importBtn" style="flex:1;background:#27ae60">📥 导入/从剪贴板导入</button> <button id="importImage" title="导入图片">🖼 导入图片</button></div><textarea id="exportOutput" placeholder="导出的像素画数据会显示在这里..."></textarea><div style="margin-top:8px;font-size:12px;color:#666">💡 每一行形如 <code>- [0, 1, 2, ...]</code>, 每个数字代表颜色在调色板中的序号（0-F）, 从左到右、从上到下排列。</div></div><div class="panel-section"><h3>充值解锁更多功能</h3><button id="unlock" style="margin-top:10px;width:100%" onclick="handleUnlockClick()">充值</button></div></div></div></div><script>function isMobileDevice(){return void 0!==window.orientation||-1!==navigator.userAgent.indexOf("IEMobile")}isMobileDevice()&&alert("像素画编辑器不支持移动设备访问，部分工具会无法使用，请使用桌面浏览器获得完整体验");let COLS=45,ROWS=45,PIXEL_SIZE=10;const MAX_HISTORY=500;let currentColor="#000000",tool="pen",symmetryMode="none",previousTool=null,isColorPicking=!1,selectionMode=null,selectionPixels=new Set,selectionBounds=null,clipboard=null,pasteOffset=null,moveOrigin=null,isSelecting=!1,isDraggingPaste=!1,lastToggledKey=null,colorPalette=["#FFFFFF","#D3D3D3","#808080","#000000","#B02E26","#5E7C16","#835432","#3C44AA","#8932B8","#169C9C","#F38BAA","#80C71F","#FED83D","#3AB3DA","#C74EBD","#F9801D"],pixelData=[],historyStack=[],redoStack=[],currentStep=null,moveBackup=null,isMoving=!1,currentMousePos={x:0,y:0};const canvas=document.getElementById("canvas"),canvasWrapper=document.getElementById("canvasWrapper"),previewLayer=document.getElementById("previewLayer"),selectionLayer=document.getElementById("selectionLayer"),colorPaletteContainer=document.getElementById("colorPalette"),exportOutput=document.getElementById("exportOutput");function setActiveTool(e){tool=e,document.querySelectorAll(".btn-group button").forEach(e=>e.classList.remove("active"));const t=document.getElementById(e);t&&t.classList.add("active"),refreshSymmetry()}function refreshSymmetry(){document.querySelectorAll(".symmetry-btn").forEach(e=>{e.dataset.mode===symmetryMode?e.classList.add("active"):e.classList.remove("active")})}function setActiveSelection(e){document.querySelectorAll("#selRect,#selFree").forEach(e=>e.classList.remove("active"));const t=document.getElementById(e);t&&t.classList.add("active"),refreshSymmetry()}function initData(){pixelData=Array.from({length:ROWS},()=>Array.from({length:COLS},()=>colorPalette[0]))}function resizeWrapper(){PIXEL_SIZE=Math.min(Math.min(.0125*window.innerWidth,.03*window.innerHeight),20)||10,canvas.style.gridTemplateColumns=`repeat(${COLS}, ${PIXEL_SIZE}px)`,canvas.style.gridTemplateRows=`repeat(${ROWS}, ${PIXEL_SIZE}px)`,canvas.style.width=COLS*PIXEL_SIZE+"px",canvas.style.height=ROWS*PIXEL_SIZE+"px",canvasWrapper.style.width=COLS*PIXEL_SIZE+18+"px",canvasWrapper.style.height=ROWS*PIXEL_SIZE+18+"px",previewLayer.style.width=COLS*PIXEL_SIZE+"px",previewLayer.style.height=ROWS*PIXEL_SIZE+"px",selectionLayer.style.width=COLS*PIXEL_SIZE+"px",selectionLayer.style.height=ROWS*PIXEL_SIZE+"px",document.querySelectorAll(".pixel").forEach(e=>{e.style.width=`${PIXEL_SIZE}px`,e.style.height=`${PIXEL_SIZE}px`})}function initCanvas(){canvas.innerHTML="",resizeWrapper();for(let e=0;e<ROWS;e++)for(let t=0;t<COLS;t++){const n=document.createElement("div");n.className="pixel",n.dataset.x=t,n.dataset.y=e,n.style.width=PIXEL_SIZE+"px",n.style.height=PIXEL_SIZE+"px",n.style.backgroundColor=pixelData[e][t],canvas.appendChild(n)}renderSelectionLayer()}window.addEventListener("resize",resizeWrapper);let basePalette=colorPalette.slice(),currentMapping=basePalette.slice(),remapSelected=null;function initRemapPanel(){basePalette=colorPalette.slice(),currentMapping&&currentMapping.length===basePalette.length||(currentMapping=basePalette.slice());const e=document.getElementById("remapGrid");e&&(e.innerHTML="",basePalette.forEach((t,n)=>{const o=document.createElement("div");o.className="remap-cell",o.style.backgroundColor=currentMapping[n],o.dataset.index=n,o.addEventListener("click",()=>onRemapClick(n,o)),e.appendChild(o)}))}function refreshRemapGrid(){const e=document.getElementById("remapGrid");e&&(e.querySelectorAll(".remap-cell").forEach(e=>{const t=Number(e.dataset.index);e.style.backgroundColor=currentMapping[t],e.classList.remove("selected")}),remapSelected=null)}function applyPaletteMapping(e){if(!Array.isArray(e)||e.length!==basePalette.length)return void console.warn("remap length mismatch",e,basePalette);const t=new Map;for(let e=0;e<currentMapping.length;e++)t.set(currentMapping[e],e);const n=[];for(let o=0;o<ROWS;o++)for(let l=0;l<COLS;l++){const r=pixelData[o][l],a=t.has(r)?t.get(r):void 0;if("number"==typeof a){const t=e[a];t!==r&&(n.push({x:l,y:o,oldColor:r,newColor:t}),setPixelDirect(l,o,t))}}n.length>0&&pushHistory(n),currentMapping=e.slice(),refreshRemapGrid()}function onRemapClick(e,t){if(null===remapSelected)return remapSelected=e,void t.classList.add("selected");if(remapSelected===e)return t.classList.remove("selected"),void(remapSelected=null);const n=currentMapping.slice();[n[e],n[remapSelected]]=[n[remapSelected],n[e]],remapSelected=null,applyPaletteMapping(n)}function getSymmetryPoints(e,t){const n=[{x:e,y:t}],o=(COLS-1)/2,l=(ROWS-1)/2;switch(symmetryMode){case"horizontal":n.push({x:COLS-1-e,y:t});break;case"vertical":n.push({x:e,y:ROWS-1-t});break;case"both":n.push({x:COLS-1-e,y:t}),n.push({x:e,y:ROWS-1-t}),n.push({x:COLS-1-e,y:ROWS-1-t});break;case"rotate4":{const r=e-o,a=t-l;n.push({x:Math.round(o-a),y:Math.round(l+r)}),n.push({x:Math.round(o-r),y:Math.round(l-a)}),n.push({x:Math.round(o+a),y:Math.round(l-r)});break}case"rotate8":{const r=e-o,a=t-l;n.push({x:Math.round(o-a),y:Math.round(l+r)}),n.push({x:Math.round(o-r),y:Math.round(l-a)}),n.push({x:Math.round(o+a),y:Math.round(l-r)}),n.push({x:Math.round(o+a),y:Math.round(l+r)}),n.push({x:Math.round(o-a),y:Math.round(l-r)}),n.push({x:Math.round(o+r),y:Math.round(l-a)}),n.push({x:Math.round(o-r),y:Math.round(l+a)});break}}const r=new Set;return n.filter(e=>{if(e.x<0||e.x>=COLS||e.y<0||e.y>=ROWS)return!1;const t=`${e.x},${e.y}`;return!r.has(t)&&(r.add(t),!0)})}function setPixelDirect(e,t,n){pixelData[t][e]=n;const o=canvas.querySelector(`.pixel[data-x="${e}"][data-y="${t}"]`);o&&(o.style.backgroundColor=n)}function drawPixel(e,t,n=null){const o=n||("eraser"===tool?colorPalette[0]:currentColor);getSymmetryPoints(e,t).forEach(e=>{const t=pixelData[e.y][e.x];t!==o&&(currentStep&&currentStep.push({x:e.x,y:e.y,oldColor:t,newColor:o}),setPixelDirect(e.x,e.y,o))})}function updateSelectionBounds(){if(0===selectionPixels.size)return void(selectionBounds=null);let e=COLS,t=ROWS,n=0,o=0;selectionPixels.forEach(l=>{const[r,a]=l.split(",").map(Number);e=Math.min(e,r),t=Math.min(t,a),n=Math.max(n,r),o=Math.max(o,a)}),selectionBounds={minX:e,minY:t,maxX:n,maxY:o}}function renderSelectionLayer(){if(selectionLayer.innerHTML="",clipboard&&pasteOffset){for(let e=0;e<clipboard.h;e++)for(let t=0;t<clipboard.w;t++){const n=clipboard.cells[e][t];if(null==n)continue;const o=pasteOffset.x+t,l=pasteOffset.y+e;if(o<0||o>=COLS||l<0||l>=ROWS)continue;const r=document.createElement("div");r.className="sel-preview",r.style.left=o*PIXEL_SIZE+"px",r.style.top=l*PIXEL_SIZE+"px",r.style.width=PIXEL_SIZE+"px",r.style.height=PIXEL_SIZE+"px",r.style.backgroundColor=n,selectionLayer.appendChild(r)}const e=document.createElement("div");return e.className="sel-border",e.style.left=pasteOffset.x*PIXEL_SIZE+"px",e.style.top=pasteOffset.y*PIXEL_SIZE+"px",e.style.width=clipboard.w*PIXEL_SIZE+"px",e.style.height=clipboard.h*PIXEL_SIZE+"px",void selectionLayer.appendChild(e)}if(selectionPixels.forEach(e=>{const[t,n]=e.split(",").map(Number),o=document.createElement("div");o.className="sel-pixel",o.style.left=t*PIXEL_SIZE+"px",o.style.top=n*PIXEL_SIZE+"px",o.style.width=PIXEL_SIZE+"px",o.style.height=PIXEL_SIZE+"px",selectionLayer.appendChild(o)}),selectionBounds){const e=selectionBounds,t=document.createElement("div");t.className="sel-border",t.style.left=e.minX*PIXEL_SIZE+"px",t.style.top=e.minY*PIXEL_SIZE+"px",t.style.width=(e.maxX-e.minX+1)*PIXEL_SIZE+"px",t.style.height=(e.maxY-e.minY+1)*PIXEL_SIZE+"px",selectionLayer.appendChild(t)}}function setSelectionFromRect(e,t,n,o,l=!1){l||selectionPixels.clear();const r=Math.max(0,Math.min(e,n)),a=Math.min(COLS-1,Math.max(e,n)),i=Math.max(0,Math.min(t,o)),s=Math.min(ROWS-1,Math.max(t,o));for(let e=i;e<=s;e++)for(let t=r;t<=a;t++)selectionPixels.add(`${t},${e}`);updateSelectionBounds(),renderSelectionLayer()}function toggleSelectionPixel(e,t){const n=`${e},${t}`;selectionPixels.has(n)?selectionPixels.delete(n):selectionPixels.add(n),updateSelectionBounds(),renderSelectionLayer()}function copySelection(){if(!selectionBounds)return alert("没有选区");const e=selectionBounds,t=e.maxX-e.minX+1,n=e.maxY-e.minY+1,o=Array.from({length:n},()=>Array.from({length:t},()=>null));for(let t=e.minY;t<=e.maxY;t++)for(let n=e.minX;n<=e.maxX;n++){const l=`${n},${t}`;selectionPixels.has(l)?o[t-e.minY][n-e.minX]=pixelData[t][n]:o[t-e.minY][n-e.minX]=null}clipboard={w:t,h:n,cells:o},pasteOffset={x:e.minX,y:e.minY},moveOrigin=null,renderSelectionLayer()}function cutSelection(){if(!selectionBounds)return alert("没有选区");copySelection();const e=colorPalette[0],t=[];selectionPixels.forEach(n=>{const[o,l]=n.split(",").map(Number);t.push({x:o,y:l,oldColor:pixelData[l][o],newColor:e}),setPixelDirect(o,l,e)}),pushHistory(t),selectionPixels.clear(),updateSelectionBounds(),renderSelectionLayer()}function beginPaste(){if(!clipboard)return alert("剪贴板为空");const e=void 0!==currentMousePos&&currentMousePos?currentMousePos:null,t=e?e.x-Math.floor(clipboard.w/2):selectionBounds?selectionBounds.minX:0,n=e?e.y-Math.floor(clipboard.h/2):selectionBounds?selectionBounds.minY:0,o=Math.max(0,COLS-clipboard.w),l=Math.max(0,ROWS-clipboard.h);pasteOffset={x:Math.max(0,Math.min(o,t)),y:Math.max(0,Math.min(l,n))},selectionMode="paste",renderSelectionLayer()}function beginMove(){if(!selectionBounds)return alert("没有选区");moveBackup=[];const e=selectionBounds,t=e.maxX-e.minX+1,n=e.maxY-e.minY+1,o=Array.from({length:n},()=>Array.from({length:t},()=>null)),l=[];for(let t=e.minY;t<=e.maxY;t++)for(let n=e.minX;n<=e.maxX;n++){const r=`${n},${t}`;selectionPixels.has(r)?(o[t-e.minY][n-e.minX]=pixelData[t][n],l.push({x:n,y:t,oldColor:pixelData[t][n]})):o[t-e.minY][n-e.minX]=null}clipboard={w:t,h:n,cells:o},pasteOffset={x:e.minX,y:e.minY},moveOrigin=l,selectionMode="move";const r=[];moveOrigin&&moveOrigin.length>0&&moveOrigin.forEach(e=>{r.push({x:e.x,y:e.y,oldColor:pixelData[e.y][e.x],newColor:colorPalette[0]}),setPixelDirect(e.x,e.y,colorPalette[0])}),r.length>0&&pushHistory(r),renderSelectionLayer()}function applyPaste(){if(!clipboard||!pasteOffset)return;const e=[];for(let t=0;t<clipboard.h;t++)for(let n=0;n<clipboard.w;n++){const o=clipboard.cells[t][n];if(null==o)continue;const l=pasteOffset.x+n,r=pasteOffset.y+t;l<0||l>=COLS||r<0||r>=ROWS||(e.push({x:l,y:r,oldColor:pixelData[r][l],newColor:o}),setPixelDirect(l,r,o))}e.length>0&&pushHistory(e),pasteOffset=null,moveOrigin=null,selectionMode=null,setActiveSelection(null),selectionPixels.clear(),updateSelectionBounds(),renderSelectionLayer()}function clearSelection(){selectionPixels.clear(),selectionBounds=null,pasteOffset=null,moveOrigin=null,selectionMode=null,setActiveSelection(null),renderSelectionLayer()}function pushHistory(e){e&&0!==e.length&&(historyStack.push(e),historyStack.length>500&&historyStack.shift(),redoStack=[])}function undo(){const e=historyStack.pop();e&&(e.forEach(e=>setPixelDirect(e.x,e.y,e.oldColor)),redoStack.push(e))}function redo(){const e=redoStack.pop();e&&(e.forEach(e=>setPixelDirect(e.x,e.y,e.newColor)),historyStack.push(e))}function getLinePixels(e,t,n,o){const l=[];let r=Math.abs(n-e),a=Math.abs(o-t),i=e<n?1:-1,s=t<o?1:-1,c=r-a;for(;l.push({x:e,y:t}),e!==n||t!==o;){let n=2*c;n>-a&&(c-=a,e+=i),n<r&&(c+=r,t+=s)}return l}function getRectPixels(e,t,n,o,l=!1){const r=[],a=Math.min(e,n),i=Math.max(e,n),s=Math.min(t,o),c=Math.max(t,o);for(let e=s;e<=c;e++)for(let t=a;t<=i;t++)l&&t!==a&&t!==i&&e!==s&&e!==c||r.push({x:t,y:e});return r}function getCirclePixels(e,t,n,o=!1){const l=[];for(let r=-n;r<=n;r++)for(let a=-n;a<=n;a++){const i=a*a+r*r;o?Math.abs(i-n*n)<=Math.max(1,n)&&l.push({x:e+a,y:t+r}):i<=n*n&&l.push({x:e+a,y:t+r})}return l}function floodFill(e,t,n,o,l=!1){if(n===o)return[];const r=[{x:e,y:t}],a=new Set,i=[];for(;r.length;){const e=r.pop();if(e.x<0||e.x>=COLS||e.y<0||e.y>=ROWS)continue;const t=`${e.x},${e.y}`;a.has(t)||(a.add(t),pixelData[e.y][e.x]===n&&(i.push({x:e.x,y:e.y}),r.push({x:e.x+1,y:e.y}),r.push({x:e.x-1,y:e.y}),r.push({x:e.x,y:e.y+1}),r.push({x:e.x,y:e.y-1})))}if(l)return i;const s=[];return i.forEach(e=>{s.push({x:e.x,y:e.y,oldColor:pixelData[e.y][e.x],newColor:o}),setPixelDirect(e.x,e.y,o)}),s.length>0&&pushHistory(s),i}function renderPreview(e){previewLayer.innerHTML="",e&&0!==e.length&&e.forEach(e=>{const t=document.createElement("div");t.style.position="absolute",t.style.width=PIXEL_SIZE+"px",t.style.height=PIXEL_SIZE+"px",t.style.left=e.x*PIXEL_SIZE+"px",t.style.top=e.y*PIXEL_SIZE+"px",t.style.backgroundColor=currentColor,t.style.opacity=.35,previewLayer.appendChild(t)})}function exportAsText(){let e="";for(let t=0;t<ROWS;t++){e+="- [";const n=[];for(let e=0;e<COLS;e++){const o=colorPalette.indexOf(pixelData[t][e]);n.push(o>=0?o.toString(16).toUpperCase():"0")}e+=n.join(", ")+"]\n"}exportOutput.value=e,navigator.clipboard.writeText(e).then(()=>{showToast("导出的内容已复制到剪贴板")}).catch(e=>{showToast("无法复制到剪贴板: ",e)})}function importFromText(){const e=exportOutput.value.trim();if(e)try{const t=e.split("\n").map(e=>e.trim()).filter(e=>0!==e.length).map(e=>e.replace(/^- +\[/,"").replace(/]$/,"")).filter(e=>e.trim()),n=t.length,o=t[0].split(",").length;let l=Math.floor((COLS-o)/2),r=Math.floor((ROWS-n)/2);o>COLS&&(l=0),n>ROWS&&(r=0);const a=[];for(let e=0;e<ROWS;e++){const i=[];for(let a=0;a<COLS;a++){const s=a-l,c=e-r;if(s<0||s>=o||c<0||c>=n)i.push(colorPalette[0]);else{const e=t[c].split(",")[s].trim().toUpperCase();let n=null;if(n=/^[0-9A-F]$/.test(e)?parseInt(e,16):parseInt(e,10),isNaN(n)||n<0||n>=colorPalette.length)throw new Error(`颜色索引无效: ${e}`);i.push(colorPalette[n])}}a.push(i),showToast("成功导入！")}pixelData=a,initCanvas()}catch(e){showToast("导入失败: "+e.message)}else navigator.clipboard.readText().then(e=>{const t=e.trim();if(t)try{const e=t.split("\n").map(e=>e.trim()).filter(e=>0!==e.length).map(e=>e.replace(/^- +\[/,"").replace(/]$/,"")).filter(e=>e.trim()),n=e.length,o=e[0].split(",").length;let l=Math.floor((COLS-o)/2),r=Math.floor((ROWS-n)/2);o>COLS&&(l=0),n>ROWS&&(r=0);const a=[];for(let t=0;t<ROWS;t++){const i=[];for(let a=0;a<COLS;a++){const s=a-l,c=t-r;if(s<0||s>=o||c<0||c>=n)i.push(colorPalette[0]);else{const t=e[c].split(",")[s].trim().toUpperCase();let n=null;if(n=/^[0-9A-F]$/.test(t)?parseInt(t,16):parseInt(t,10),isNaN(n)||n<0||n>=colorPalette.length)throw new Error(`颜色索引无效: ${t}`);i.push(colorPalette[n])}}a.push(i),showToast("成功导入！")}pixelData=a,initCanvas()}catch(e){showToast("导入失败: "+e.message)}else showToast("请先粘贴像素画数据")}).catch(e=>{console.error("无法读取剪贴板: ",e),showToast("无法读取剪贴板，请手动粘贴数据")})}function showToast(e){const t=document.createElement("div");t.className="toast",t.innerText=e,document.body.appendChild(t),setTimeout(()=>{t.classList.add("show"),setTimeout(()=>{t.classList.remove("show"),setTimeout(()=>{document.body.removeChild(t)},300)},2e3)},10)}function getPixelFromEvent(e){const t=canvas.getBoundingClientRect(),n=Math.floor((e.clientX-t.left)/PIXEL_SIZE),o=Math.floor((e.clientY-t.top)/PIXEL_SIZE);return n>=0&&n<COLS&&o>=0&&o<ROWS?{x:n,y:o}:null}document.getElementById("shuffleColors").addEventListener("click",()=>{const e=currentMapping.slice();for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}applyPaletteMapping(e)}),document.getElementById("resetRemap").addEventListener("click",()=>{applyPaletteMapping(basePalette.slice())});let isDrawing=!1,startX=null,startY=null;function setupEventListeners(){function e(e,t){const n=document.getElementById(e);n.addEventListener("click",()=>{tool=t,document.querySelectorAll(".btn-group button").forEach(e=>e.classList.remove("active")),refreshSymmetry(),n.classList.add("active"),previewLayer.innerHTML="",startX=startY=null,isDrawing=!1})}function t(e,t,n){return"#"+[e,t,n].map(e=>e.toString(16).padStart(2,"0")).join("")}function n(e,t){const[n,l,r]=o(t);let a=1/0,i=e[0];for(const t of e){const[e,s,c]=o(t),d=(n-e)**2+(l-s)**2+(r-c)**2;d<a&&(a=d,i=t)}return i}function o(e){const t=parseInt(e.slice(1),16);return[t>>16&255,t>>8&255,255&t]}window.addEventListener("beforeunload",e=>{e.preventDefault(),e.returnValue="⚠️ 数据将不会保存, 确定退出吗？"}),e("pen","pen"),e("eraser","eraser"),e("line","line"),e("rect","rect"),e("circle","circle"),e("fill","fill"),e("eyedropper","eyedropper"),document.getElementById("selRect").addEventListener("click",()=>{selectionMode="rect",selectionPixels.clear(),selectionBounds=null,setActiveSelection("selRect"),renderSelectionLayer()}),document.getElementById("selFree").addEventListener("click",()=>{selectionMode="free",selectionPixels.clear(),selectionBounds=null,setActiveSelection("selFree"),renderSelectionLayer()}),document.getElementById("selMove").addEventListener("click",()=>{if(!selectionBounds)return alert("先选区再移动");beginMove()}),document.getElementById("selCopy").addEventListener("click",()=>{copySelection()}),document.getElementById("selCut").addEventListener("click",()=>{cutSelection()}),document.getElementById("selPaste").addEventListener("click",()=>{beginPaste()}),document.getElementById("selClear").addEventListener("click",()=>{clearSelection()}),document.getElementById("undo").addEventListener("click",undo),document.getElementById("redo").addEventListener("click",redo),document.getElementById("clear").addEventListener("click",()=>{confirm("确定要清空画布吗？")&&(initData(),initCanvas(),historyStack=[],redoStack=[])}),document.getElementById("toggleGrid").addEventListener("click",()=>{document.getElementById("canvasWrapper").classList.toggle("no-grid")}),document.getElementById("exportBtn").addEventListener("click",exportAsText),document.getElementById("importBtn").addEventListener("click",importFromText),document.getElementById("importImage").addEventListener("click",()=>{const e=document.createElement("input");e.type="file",e.accept="image/*",e.onchange=e=>{const o=e.target.files[0];if(!o)return;const l=new FileReader;l.onload=e=>async function(e){const o=new Image;o.crossOrigin="anonymous",o.onload=()=>{const e=document.createElement("canvas");e.width=COLS,e.height=ROWS;const l=e.getContext("2d",{willReadFrequently:!0});l.imageSmoothingEnabled=!1,l.drawImage(o,0,0,e.width,e.height);const r=l.getImageData(0,0,e.width,e.height).data;for(let e=0;e<ROWS;e++)for(let o=0;o<COLS;o++){const l=4*(e*COLS+o),a=t(r[l],r[l+1],r[l+2]),i=n(colorPalette,a);pixelData[e][o]=i;const s=canvas.querySelector(`.pixel[data-x="${o}"][data-y="${e}"]`);s&&(s.style.backgroundColor=i)}},o.src=e}(e.target.result),l.readAsDataURL(o)},e.click()}),document.querySelectorAll(".symmetry-btn").forEach(e=>{e.addEventListener("click",function(){document.querySelectorAll(".symmetry-btn").forEach(e=>e.classList.remove("active")),this.classList.add("active"),symmetryMode=this.dataset.mode})}),document.querySelector('.symmetry-btn[data-mode="none"]').classList.add("active"),canvas.addEventListener("mousedown",e=>{if(0!==e.button)return;const t=getPixelFromEvent(e);if(t){if("rect"===selectionMode)return isSelecting=!0,dragStart=t,void(lastToggledKey=null);if("free"===selectionMode)return isSelecting=!0,dragStart=t,lastToggledKey=`${t.x},${t.y}`,void toggleSelectionPixel(t.x,t.y);if(("paste"===selectionMode||"move"===selectionMode)&&clipboard)return isDraggingPaste=!0,void(dragStart=t);if("pen"===tool||"eraser"===tool)return isDrawing=!0,currentStep=[],drawPixel(t.x,t.y,null),void(canvas._curStep=currentStep);if("eyedropper"===tool){if(!t)return;const e=pixelData[t.y][t.x];if(e){currentColor=e,document.querySelectorAll(".color-btn").forEach(e=>e.classList.remove("selected"));const t=colorPaletteContainer.querySelectorAll(".color-btn"),n=colorPalette.indexOf(e);t[n]&&t[n].classList.add("selected")}return void(previewLayer.innerHTML="")}if("fill"===tool){const e=pixelData[t.y][t.x],n=currentColor;return e!==n&&floodFill(t.x,t.y,e,n,!1),void(previewLayer.innerHTML="")}"line"!==tool&&"rect"!==tool&&"circle"!==tool||(startX=t.x,startY=t.y)}}),canvas.addEventListener("mousemove",e=>{const t=getPixelFromEvent(e);if(t){if(currentMousePos=t,isSelecting&&"rect"===selectionMode&&dragStart){const n=e.shiftKey;return void setSelectionFromRect(dragStart.x,dragStart.y,t.x,t.y,n)}if(isSelecting&&"free"===selectionMode){const e=`${t.x},${t.y}`;return void(e!==lastToggledKey&&(toggleSelectionPixel(t.x,t.y),lastToggledKey=e))}if(isDraggingPaste&&clipboard&&("paste"===selectionMode||"move"===selectionMode)){const e=t.x-dragStart.x,n=t.y-dragStart.y;return pasteOffset={x:Math.max(-clipboard.w,Math.min(COLS,pasteOffset.x+e)),y:Math.max(-clipboard.h,Math.min(ROWS,pasteOffset.y+n))},dragStart=t,void renderSelectionLayer()}if(!isDrawing||"pen"!==tool&&"eraser"!==tool){if(null!==startX&&null!==startY){const n=e.shiftKey;let o=[];if("line"===tool)o=getLinePixels(startX,startY,t.x,t.y);else if("rect"===tool)o=getRectPixels(startX,startY,t.x,t.y,n);else if("circle"===tool){const e=Math.round(Math.sqrt((t.x-startX)**2+(t.y-startY)**2));o=getCirclePixels(startX,startY,e,n)}renderPreview(o)}}else drawPixel(t.x,t.y,null)}}),document.addEventListener("mouseup",e=>{const t=getPixelFromEvent(e);if(isSelecting&&"rect"===selectionMode)return isSelecting=!1,void(dragStart=null);if(isSelecting&&"free"===selectionMode)return isSelecting=!1,dragStart=null,void(lastToggledKey=null);if(isDraggingPaste)return isDraggingPaste=!1,void(dragStart=null);if(isDrawing&&(isDrawing=!1,canvas._curStep&&canvas._curStep.length>0&&(pushHistory(canvas._curStep),canvas._curStep=null,currentStep=null)),null!==startX&&null!==startY&&t){const n=e.shiftKey;if(currentStep=[],"line"===tool){getLinePixels(startX,startY,t.x,t.y).forEach(e=>drawPixel(e.x,e.y,null))}else if("rect"===tool){getRectPixels(startX,startY,t.x,t.y,n).forEach(e=>drawPixel(e.x,e.y,null))}else if("circle"===tool){const e=Math.round(Math.sqrt((t.x-startX)**2+(t.y-startY)**2));getCirclePixels(startX,startY,e,n).forEach(e=>drawPixel(e.x,e.y,null))}currentStep&&currentStep.length>0&&(pushHistory(currentStep),currentStep=null)}startX=startY=null,previewLayer.innerHTML=""}),document.addEventListener("keydown",e=>{const t=document.activeElement&&document.activeElement.tagName?document.activeElement.tagName.toLowerCase():"",n="input"===t||"textarea"===t||document.activeElement&&document.activeElement.isContentEditable;"Enter"===e.key&&("paste"===selectionMode&&clipboard||"move"===selectionMode&&clipboard)&&applyPaste(),"Escape"===e.key&&(clearSelection(),previewLayer.innerHTML=""),n||(e.ctrlKey&&"c"===e.key.toLowerCase()&&(e.preventDefault(),copySelection()),e.ctrlKey&&"x"===e.key.toLowerCase()&&(e.preventDefault(),cutSelection()),e.ctrlKey&&"v"===e.key.toLowerCase()&&(e.preventDefault(),beginPaste()),e.ctrlKey&&"z"===e.key.toLowerCase()&&(e.preventDefault(),undo()),e.ctrlKey&&"y"===e.key.toLowerCase()&&(e.preventDefault(),redo())),"Alt"!==e.key&&"AltLeft"!==e.code&&"AltRight"!==e.code||isColorPicking||(e.preventDefault(),isColorPicking=!0,previousTool=tool,setActiveTool("eyedropper"))}),document.addEventListener("keyup",e=>{"Alt"!==e.key&&"AltLeft"!==e.code&&"AltRight"!==e.code||!isColorPicking||(isColorPicking=!1,setActiveTool(previousTool||"pen"),previousTool=null)}),window.addEventListener("blur",()=>{isColorPicking&&(window._wasColorPicking=!0)}),window.addEventListener("focus",()=>{window._wasColorPicking&&(window._wasColorPicking=!1,isColorPicking=!1,setActiveTool(previousTool||"pen"),previousTool=null)}),canvas.addEventListener("dragstart",e=>(e.preventDefault(),!1))}function renderColorPalette(){colorPaletteContainer.innerHTML="",colorPalette.forEach((e,t)=>{const n=document.createElement("div");n.className="color-btn",n.style.backgroundColor=e,n.dataset.color=e,n.title=`${t}: ${e}`,3===t&&n.classList.add("selected"),n.addEventListener("click",()=>{document.querySelectorAll(".color-btn").forEach(e=>e.classList.remove("selected")),n.classList.add("selected"),currentColor=e}),colorPaletteContainer.appendChild(n)});const e=document.createElement("div");e.style.cssText="width:100%;text-align:center;margin-top:6px;font-size:12px;color:#666",colorPaletteContainer.appendChild(e)}function handleUnlockClick(){window.open("https://live.bilibili.com/52030","_blank");var e=document.getElementById("unlock");e.textContent="已激活",e.style.backgroundColor="#ccc",e.style.color="#666",e.style.cursor="not-allowed",e.disabled=!0,spawnToyAvatar()}initData(),renderColorPalette(),initRemapPanel(),initCanvas(),setupEventListeners();let _toyAvatarCreated=!1,_audioCtx=null;function playToySqueak(){try{_audioCtx||(_audioCtx=new(window.AudioContext||window.webkitAudioContext));const e=_audioCtx,t=e.currentTime,n=e.createOscillator();n.type="triangle",n.frequency.setValueAtTime(600,t),n.frequency.exponentialRampToValueAtTime(1400,t+.12);const o=e.createGain();o.gain.setValueAtTime(0,t),o.gain.linearRampToValueAtTime(.9,t+.01),o.gain.exponentialRampToValueAtTime(1e-4,t+.28);const l=2*e.sampleRate,r=e.createBuffer(1,l,e.sampleRate),a=r.getChannelData(0);for(let e=0;e<l;e++)a[e]=(2*Math.random()-1)*(1-e/l);const i=e.createBufferSource();i.buffer=r;const s=e.createBiquadFilter();s.type="bandpass",s.frequency.value=1600,s.Q.value=.7;const c=e.createGain();c.gain.setValueAtTime(5e-4,t),c.gain.exponentialRampToValueAtTime(.05,t+.01),c.gain.exponentialRampToValueAtTime(1e-5,t+.18);const d=e.createGain();d.gain.value=.9,n.connect(o),o.connect(d),i.connect(s),s.connect(c),c.connect(d),d.connect(e.destination),n.start(t),i.start(t),n.stop(t+.32),i.stop(t+.32),setTimeout(()=>{try{n.disconnect(),i.disconnect(),o.disconnect(),c.disconnect(),d.disconnect(),s.disconnect()}catch(e){}},500)}catch(e){console.warn("Audio not available:",e)}}function spawnToyAvatar(){if(_toyAvatarCreated)return;_toyAvatarCreated=!0;const e=document.createElement("div");e.id="toyAvatar",e.setAttribute("role","button");const t=document.createElement("div");t.className="hint",t.textContent="🎵",e.appendChild(t),e.innerHTML+='\n    <img\n      src="https://i2.hdslb.com/bfs/face/d92f3bea64c4bac4e80909405bd126b8666e012d.jpg@128w_128h_1c_1s.webp"\n      alt="Aza头像"\n      title="Aza头像"\n    />\n  ',document.body.appendChild(e),e.addEventListener("click",t=>{e.classList.remove("squeeze"),e.offsetWidth,e.classList.add("squeeze"),playToySqueak()}),e.addEventListener("mousedown",()=>e.style.transform="scale(0.98)"),e.addEventListener("mouseup",()=>e.style.transform=""),e.addEventListener("mouseleave",()=>e.style.transform="")}</script><div style="text-align:center"><a>&copy; 2025 Astrorbits NMBCT™ §AZA圣诞活动专用§</a></div></body></html>